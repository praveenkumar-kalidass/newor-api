name: Build & Deply Dev
on:
  workflow_run:
    workflows: [Validate]
    types: [completed]
jobs:
  build:
    name: build
    env:
      DEV_EC2_PRIVATE_KEY: ${{ secrets.DEV_EC2_PRIVATE_KEY }}
      DEV_EC2_USERNAME: ${{ secrets.DEV_EC2_USERNAME }}
      DEV_EC2_HOSTNAME: ${{ secrets.DEV_EC2_HOSTNAME }}
      DEV_API_PORT: ${{ secrets.DEV_API_PORT }}
      DEV_POSTGRES_USER: ${{ secrets.DEV_POSTGRES_USER }}
      DEV_POSTGRES_PASSWORD: ${{ secrets.DEV_POSTGRES_PASSWORD }}
      DEV_DATABASE_NAME: ${{ secrets.DEV_DATABASE_NAME }}
      DEV_DATABASE_USER: ${{ secrets.DEV_DATABASE_USER }}
      DEV_DATABASE_PASSWORD: ${{ secrets.DEV_DATABASE_PASSWORD }}
    runs-on: macos-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: git checkout
        uses: actions/checkout@v2
      - name: clean
        run: |
          echo "$DEV_EC2_PRIVATE_KEY" > newor_dev.pem && chmod 400 newor_dev.pem
          ssh -o StrictHostKeyChecking=no -i newor_dev.pem ${DEV_EC2_USERNAME}@${DEV_EC2_HOSTNAME} '
            cd ~/newor/newor-api
            docker-compose down
            sudo rm -rf ~/newor && mkdir -p ~/newor/newor-api
          '
      - name: environment config
        run: |
          echo "export ENV=dev
          export PORT=$DEV_API_PORT
          export POSTGRES_USER=$DEV_POSTGRES_USER
          export POSTGRES_PASSWORD=$DEV_POSTGRES_PASSWORD
          export DATABASE_HOST=postgres
          export DATABASE_SUPERUSER=$DEV_POSTGRES_USER
          export DATABASE_SUPERPASSWORD=$DEV_POSTGRES_PASSWORD" > .envrc
      - name: database config
        run: |
          echo "{
            \"dev\":{
              \"username\":\"$DEV_DATABASE_USER\",
              \"password\":\"$DEV_DATABASE_PASSWORD\",
              \"database\":\"$DEV_DATABASE_NAME\",
              \"host\":\"postgres\",
              \"dialect\":\"postgres\",
              \"migrationStorage\":\"sequelize\",
              \"seederStorage\":\"sequelize\"
            }
          }" > config/database.json
      - name: copy files
        run: |
          scp -r -i newor_dev.pem ./* ${DEV_EC2_USERNAME}@${DEV_EC2_HOSTNAME}:~/newor/newor-api
          scp -i newor_dev.pem ./.envrc ${DEV_EC2_USERNAME}@${DEV_EC2_HOSTNAME}:~/newor/newor-api/.envrc
          scp -i newor_dev.pem ./.dockerignore ${DEV_EC2_USERNAME}@${DEV_EC2_HOSTNAME}:~/newor/newor-api/.dockerignore
          scp -i newor_dev.pem ./.sequelizerc ${DEV_EC2_USERNAME}@${DEV_EC2_HOSTNAME}:~/newor/newor-api/.sequelizerc
  deploy:
    name: deploy
    env:
      DEV_EC2_PRIVATE_KEY: ${{ secrets.DEV_EC2_PRIVATE_KEY }}
      DEV_EC2_USERNAME: ${{ secrets.DEV_EC2_USERNAME }}
      DEV_EC2_HOSTNAME: ${{ secrets.DEV_EC2_HOSTNAME }}
    needs: build
    runs-on: macos-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: docker compose
        run: |
          echo "$DEV_EC2_PRIVATE_KEY" > newor_dev.pem && chmod 400 newor_dev.pem
          ssh -o StrictHostKeyChecking=no -i newor_dev.pem ${DEV_EC2_USERNAME}@${DEV_EC2_HOSTNAME} '
            cd ~/newor/newor-api
            docker-compose up -d
          '